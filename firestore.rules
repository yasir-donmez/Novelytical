rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- Optimized Helper Functions ---
    function isAuth() {
      return request.auth != null;
    }
    
    function isOwner(uid) {
      return request.auth.uid == uid;
    }
    
    function hasRole(role) {
      return isAuth() && request.auth.token.role == role;
    }
    
    function isAuthorized() {
      return isAuth() && request.auth.token.authorized == true;
    }

    // --- 1. Comments (Optimized) ---
    match /comments/{commentId} {
      allow read: if true;
      allow create: if isAuth();
      allow delete: if isAuth() && isOwner(resource.data.userId);
      
      // Simplified update logic - use pre-computed authorization
      allow update: if isAuth() && (
        isOwner(resource.data.userId) || 
        request.resource.data.keys().hasOnly(['likeCount', 'dislikeCount'])
      );

      match /votes/{voteUserId} {
        allow read: if true;
        allow write: if isOwner(voteUserId);
      }
    }

    // --- 2. Reviews (Optimized) ---
    match /reviews/{reviewId} {
      allow read: if true;
      allow create: if isAuth();
      allow delete: if isAuth() && isOwner(resource.data.userId);
      
      // Simplified update with pre-computed fields
      allow update: if isAuth() && (
        isOwner(resource.data.userId) || 
        request.resource.data.keys().hasOnly(['likes', 'unlikes'])
      );
    }
    
    match /review_interactions/{interactionId} {
      allow read: if true;
      allow write: if isAuth();
    }

    // --- 3. Notifications (Optimized) ---
    match /notifications/{notifId} {
      allow read, update, delete: if isAuth() && isOwner(resource.data.recipientId);
      allow create: if isAuth();
    }

    // --- 4. Users (Optimized) ---
    match /users/{userId} {
      allow read: if true;
      allow write: if isOwner(userId);
      
      match /saved_posts/{document=**} {
        allow read, write: if isOwner(userId);
      }
    }

    // --- 5. Community (Optimized) ---
    match /community_posts/{postId} {
      allow read: if true;
      allow create: if isAuth();
      
      // Simplified update logic
      allow update: if isAuth() && (
        isOwner(resource.data.userId) || 
        request.resource.data.keys().hasOnly(['pollOptions'])
      );
      
      allow delete: if isAuth() && isOwner(resource.data.userId);
      
      match /votes/{voteId} {
        allow read: if true;
        allow write: if isOwner(voteId);
      }
    }
    
    // --- 6. Post Votes (Optimized) ---
    match /post_votes/{voteId} {
      allow read: if true;
      allow create: if isAuth() && isOwner(request.resource.data.userId);
      allow update, delete: if isAuth() && isOwner(resource.data.userId);
    }

    // --- 7. Libraries (Optimized) ---
    match /libraries/{libId} {
      allow read: if true;
      allow create: if isAuth() && isOwner(request.resource.data.userId);
      allow update, delete: if isAuth() && isOwner(resource.data.userId);
    }

    // --- 8. Novel Stats (Optimized) ---
    match /novel_stats/{novelId} {
      allow read: if true;
      allow create: if true;
      
      // Simplified view count increment
      allow update: if request.resource.data.keys().hasOnly(['viewCount']) &&
                      request.resource.data.viewCount == resource.data.viewCount + 1;
    }

    // --- 9. Social Graph (Optimized) ---
    match /follows/{followId} {
      allow read: if true;
      allow create: if isAuth() && isOwner(request.resource.data.followerId);
      allow delete: if isAuth() && (
        isOwner(resource.data.followerId) || 
        isOwner(resource.data.followingId)
      );
    }

    // --- 10. Author Follows (Optimized) ---
    match /author_follows/{followId} {
      allow read: if true;
      allow create: if isAuth() && isOwner(request.resource.data.userId);
      allow delete: if isAuth() && isOwner(resource.data.userId);
    }

    // --- 11. Chats & Messages (Optimized) ---
    match /chats/{chatId} {
      // Allow read if user is authenticated and is a participant
      // For new chats, allow read if user is part of the chatId (deterministic ID format: uid1_uid2)
      allow read: if isAuth() && (
        (resource != null && request.auth.uid in resource.data.participants) ||
        (resource == null && chatId.matches('.*' + request.auth.uid + '.*'))
      );
      allow create: if isAuth() && request.auth.uid in request.resource.data.participants;
      allow update: if isAuth() && request.auth.uid in resource.data.participants;
      allow delete: if isAuth() && request.auth.uid in resource.data.participants;
      
      match /messages/{messageId} {
        // Allow read if user is in the parent chat's participants
        // Use chatId pattern matching to avoid expensive get() calls
        allow read: if isAuth() && chatId.matches('.*' + request.auth.uid + '.*');
        allow create: if isAuth() && isOwner(request.resource.data.senderId);
        
        // Simplified message update
        allow update: if isAuth() && (
          isOwner(resource.data.senderId) || 
          request.resource.data.keys().hasOnly(['isRead'])
        );
        
        allow delete: if isAuth() && isOwner(resource.data.senderId);
      }
    }

    // --- 12. Discovery Data (New - Optimized for single endpoint) ---
    match /discovery/{discoveryId} {
      allow read: if true;
      allow write: if hasRole('admin');
    }

    // --- 13. Novel Collections (New - Optimized for story tower) ---
    match /novel_collections/{collectionId} {
      allow read: if true;
      allow write: if isAuth() && (isOwner(resource.data.userId) || hasRole('admin'));
    }

    // --- 14. Rooms (Fix for Permission Denied) ---
    match /rooms/{roomId} {
      allow read: if true;
      allow create: if isAuth(); 
      allow update: if isAuth(); // Allow updates like invalidating caches or admin actions
      allow delete: if isAuth() && (hasRole('admin') || isOwner(resource.data.creatorId));

      match /messages/{messageId} {
        allow read: if true;
        allow create: if isAuth();
        allow delete: if isAuth() && (isOwner(resource.data.userId) || hasRole('admin'));
      }
    }
  }
}
